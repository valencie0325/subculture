<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Process</title>
	<style>
		.kintsugi.defination {
			font-size: 16px;
			font-family: Arial, Helvetica, sans-serif;
		}

		body {
			font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
			line-height: 1.6;
			color: #333;
			background: #d2ccb4;
			margin: 0;
			padding: 2rem;
			display: flex;
			flex-direction: column;
			position: relative;
		}

		h1 {
			text-align: center;
			margin-bottom: 1.5rem;
			color: #b38b4d;
		}

		h2 {
			font-size: 1.4rem;
			margin: 1.8rem 0 .6rem;
			color: #5d4037;
			padding-bottom: .3rem;
		}

		.container {
			display: flex;
			align-items: center;
			max-width: 900px;
			width: 70%;
			padding: 30px;
			gap: 30px;
			margin: 0 auto;
		}

		.text {
			flex: 1;
			font-size: 18px;
			line-height: 1.8;
			color: #333;
		}

		.text h2 {
			margin-top: 0;
			color: #b38b4d;
			font-family: Georgia, serif;
		}

		.image {
			flex: 1;
			text-align: center;
			position: relative;
		}

		.image img {
			width: 100%;
			max-width: 350px;
			height: auto;
			border-radius: 12px;
			cursor: pointer;
		}

		.middle_line {
			width: 1px;
			background: #5d4037;
		}

		.nav-bar {
			position: fixed;
			bottom: 0;
			left: 0;
			width: 100%;
			background: rgba(255, 255, 255, 0.15);
			backdrop-filter: blur(12px);
			-webkit-backdrop-filter: blur(12px);
			padding: 14px 0;
			display: flex;
			justify-content: center;
			gap: 40px;
			color: rgba(255, 255, 255, 0.9);
			font-size: 13px;
			font-weight: 500;
			z-index: 1000;
			user-select: none;
		}

		.nav-item {
			color: #b38b4d;
			font-size: 22px;
			font-family: Georgia, 'Times New Roman', Times, serif;
			cursor: pointer;
		}

		.scatter-img {
			position: absolute;
			width: 150px;
			height: 150px;
			object-fit: cover;
			transition: all 3s cubic-bezier(0.25, 0.8, 0.25, 1);
			display: none;
			z-index: 9;
		}

		.disabled-image {
			filter: grayscale(100%);
			opacity: 0.2;
			cursor: not-allowed;
		}
	</style>
</head>

<body>
	<div>
		<h1>Kintsugi Repair Process</h1>
	</div>
	<div class="kintsugi defination">
		The kintsugi process is the Japanese art of repairing broken pottery with lacquer and powdered metal, such as
		gold or silver. The visible repair highlights, rather than hides, the item's history and imperfections. This
		practice, which can be done through traditional or modern methods, reflects the philosophy of wabi-sabi, which
		embraces imperfection and transience.
	</div>

	<div class="container">
		<div class="text">
			<h2>BREAK</h2>
			<p>Lay out pieces on a padded surface; identify which edges mate. Remove dust, old glue, or dirt with warm
				water and a soft brush; dry thoroughly.</p>
			<P>Dry-fit the pieces without adhesive to check alignment and any missing areas. Note gaps that will need
				fill.</P>
		</div>
		<div class="middle_line"></div>
		<div class="image">
			<img id="cup_img" src="img/cup.png" alt="BREAK">
		</div>
	</div>
	<div class="container">
		<div class="text">
			<h2>ASSEMBLE</h2>
			<p>Make joining lacquer: if using raw urushi, you may use it directly for joining. For larger gaps, mix
				urushi with fine rice flour or sawdust to make a thicker paste (jisuri) that fills voids.</p>
			<p>First join: apply a thin, even coat of lacquer to mating edges. Press pieces together, align precisely,
				and secure with gentle clamps or tape. Wipe away any squeeze-out with a clean stick before it cures.</p>
		</div>
		<div class="middle_line"></div>
		<div class="image">
			<img id="glue_img" src="img/K2/k2-2.png" alt="ASSEMBLE" height="350px" weight="350px">
		</div>
	</div>
	<div class="container">
		<div class="text">
			<h2>WAIT</h2>
			<p>Let the join cure fully in a humid, dust-free environment — allow sufficient curing time for the lacquer
				to harden fully before proceeding (Environmental humidity and lacquer type affect curing).</p>
		</div>
		<div class="middle_line"></div>
		<div class="image">
			<img id="clock_img" src="img/K3/k30-1.png" alt="WAIT">
		</div>
	</div>
	<div class="container">
		<div class="text">
			<h2>REPAIR</h2>
			<P>Fill missing areas: mix thicker lacquer paste to rebuild chips or missing sections. Sculpt the fill to
				match the shape roughly; don’t worry about finish at this stage.</P>
			<p>Build up layers: traditional kintsugi often requires several cycles: apply lacquer, let it cure, sand to
				shape, then apply more paste until the surface integrates with the original form.</p>
			<p>Final lacquer coat: apply a smooth final layer of clear urushi over the seams and filled areas to create
				an even surface for gilding.</p>
			<p>Sand the filled areas smooth, stepping through finer grits to blend with the original ceramic surface.
			</p>
		</div>
		<div class="middle_line"></div>
		<div class="image">
			<img id="paper_img" src="img/K4/K4-2.png" alt="REPAIR">
		</div>
	</div>
	<div class="container">
		<div class="text">
			<h2>REVEAL</h2>
			<p>While the final lacquer is still tacky (or by using a special adhesive called nashiji process), dust
				powdered gold lightly into the lacquer or lay gold leaf. Tap off excess gently. For brighter seams,
				repeat gilding layers as desired.</p>
		</div>
		<div class="middle_line"></div>
		<div class="image">
			<img id="brush_img" src="img/K5/k5-1.png" alt="REVEAL">
		</div>
	</div>
	<div class="container">
		<div class="text">
			<h2>SUBLIMATE</h2>
			<p>After the metallic layer has set, polish gently. Optionally brush a thin clear topcoat of epoxy or
				lacquer.</p>
		</div>
		<div class="middle_line"></div>
		<div class="image">
			<img id="finish_img" src="img/k6.png" alt="SUBLIMATE" class="disabled-image">
		</div>
	</div>

	<div class="nav-bar">
		<a href="index.html" class="nav-item">Home</a>
		<a href="process.html" class="nav-item">Process</a>
		<a href="history&story.html" class="nav-item">History</a>
		<a href="about.html" class="nav-item">About</a>
	</div>

	<script>
		const cupImg = document.getElementById('cup_img');
		const glueImg = document.getElementById('glue_img');
		const clockImg = document.getElementById('clock_img');
		const paperImg = document.getElementById('paper_img');
		const brushImg = document.getElementById('brush_img');
		const finishImg = document.getElementById('finish_img');

		let scatterImgs = [];
		let scattered = false;
		const targetW = 150, targetH = 150, margin = 30;

		// 加载 img/cup/1.png 到 9.png
		for (let i = 1; i <= 9; i++)
		{
			const img = new Image();
			img.src = `img/cup/${i}.png`;
			img.className = 'scatter-img';
			document.body.appendChild(img);
			scatterImgs.push(img);
		}

		// 生成不重叠的边缘位置
		function generateEdgePositions()
		{
			const positions = [];
			const vw = window.innerWidth, vh = window.innerHeight;
			const cells = [];

			// 上边缘
			for (let x = margin; x < vw - targetW - margin; x += targetW + margin)
			{
				cells.push({ x, y: margin, side: 0 });
			}
			// 右边缘
			for (let y = margin; y < vh - targetH - margin; y += targetH + margin)
			{
				cells.push({ x: vw - targetW - margin, y, side: 1 });
			}
			// 下边缘
			for (let x = margin; x < vw - targetW - margin; x += targetW + margin)
			{
				cells.push({ x, y: vh - targetH - margin, side: 2 });
			}
			// 左边缘
			for (let y = margin; y < vh - targetH - margin; y += targetH + margin)
			{
				cells.push({ x: margin, y, side: 3 });
			}

			// 随机打乱
			for (let i = cells.length - 1; i > 0; i--)
			{
				const j = Math.floor(Math.random() * (i + 1));
				[cells[i], cells[j]] = [cells[j], cells[i]];
			}

			// 取前 N 个
			for (let i = 0; i < scatterImgs.length; i++)
			{
				const angle = Math.random() * 360;
				const duration = 2.5 + Math.random() * 0.8; // 2.5-3.3s
				positions.push({ x: cells[i].x, y: cells[i].y, angle, duration });
			}
			return positions;
		}

		cupImg.addEventListener('mouseenter', () =>
		{
			if (scattered) return;
			const rect = cupImg.getBoundingClientRect();
			const positions = generateEdgePositions();

			scatterImgs.forEach((img, i) =>
			{
				img.style.display = 'block';
				document.body.appendChild(img);
				img.style.left = (rect.left + window.scrollX) + 'px';
				img.style.top = (rect.top + window.scrollY) + 'px';
				img.style.width = rect.width + 'px';
				img.style.height = rect.height + 'px';

				requestAnimationFrame(() =>
				{
					const pos = positions[i];
					img.style.transition = `all ${pos.duration}s cubic-bezier(0.25,0.8,0.25,1)`;
					img.style.left = pos.x + 'px';
					img.style.top = pos.y + 'px';
					img.style.transform = `rotate(${pos.angle}deg)`;
					img.style.width = targetW + 'px';
					img.style.height = targetH + 'px';
				});

				if (i == 8)
				{
					glueImg.src = "img/K2/k2-1.png";
					initDrag();
				}
			});
			cupImg.style.opacity = '0';
			scattered = true;

		});

		let isDragging = false;
		let offsetX, offsetY;
		let originalLeft, originalTop;
		const originalParent = glueImg.parentElement;
		const originalNextSibling = glueImg.nextSibling;

		// 初始化绝对定位
		function initDrag()
		{

			const rect = glueImg.getBoundingClientRect();
			originalLeft = rect.left + window.scrollX;
			originalTop = rect.top + window.scrollY;
			glueImg.style.left = originalLeft + 'px';
			glueImg.style.top = originalTop + 'px';
			glueImg.style.position = 'absolute';
			glueImg.style.cursor = 'move';
			glueImg.style.zIndex = '1001';
			document.body.appendChild(glueImg); // 移到 body 避免容器限制
		}


		glueImg.addEventListener('mousedown', (e) =>
		{
			isDragging = true;
			const rect = glueImg.getBoundingClientRect();
			offsetX = e.clientX - rect.left;
			offsetY = e.clientY - rect.top;
			glueImg.style.transition = 'none';
			e.preventDefault();
		});

		function step_waitingImg()
		{//
			if (clockImg)
			{
				const rect = clockImg.getBoundingClientRect();
				const left = rect.left + window.scrollX;
				const top = rect.top + window.scrollY;

				// 创建 K3-2
				const k32 = new Image();
				k32.src = 'img/K3/K30-2s.png';
				k32.style.position = 'absolute';
				k32.style.left = left + 'px';
				k32.style.top = top + 'px';
				k32.style.width = rect.width + 'px';
				k32.style.height = rect.height + 'px';
				k32.style.zIndex = '10';
				k32.style.transition = 'transform 15s linear';
				document.body.appendChild(k32);

				// 创建 K3-3
				const k33 = new Image();
				k33.src = 'img/K3/K30-2.png';
				k33.style.position = 'absolute';
				k33.style.left = left + 'px';
				k33.style.top = top + 'px';
				k33.style.width = rect.width + 'px';
				k33.style.height = rect.height + 'px';
				k33.style.zIndex = '10';
				document.body.appendChild(k33);

				// 旋转
				requestAnimationFrame(() =>
				{
					k32.style.transform = 'rotate(360deg)';
				});

				k32.addEventListener('transitionend', () =>
				{
					step_paperImg()
				});
			}
		}

		function step_paperImg()
		{
			// paper_img 是 REPAIR 步骤图片
			paperImg.src = 'img/K4/k4-1.png';

			// 创建遮罩区域 (120%)
			const rect = paperImg.getBoundingClientRect();
			const centerX = rect.left + rect.width / 2 + window.scrollX;
			const centerY = rect.top + rect.height / 2 + window.scrollY;
			const size = rect.width * 1.2;

			const maskArea = {
				x: centerX - size / 2,
				y: centerY - size / 2,
				width: size,
				height: size
			};

			// 创建 k4-4.png
			const k44 = new Image();
			k44.src = 'img/K4/k4-3.png';
			k44.style.position = 'absolute';
			k44.style.left = maskArea.x + 'px';
			k44.style.top = maskArea.y + 'px';
			k44.style.width = maskArea.width + 'px';
			k44.style.height = maskArea.height + 'px';
			k44.style.cursor = 'move';
			k44.style.zIndex = '1002';
			document.body.appendChild(k44);

			let isDragging4 = false;
			let startX, startY;

			k44.addEventListener('mousedown', (e) =>
			{
				isDragging4 = true;
				startX = k44.offsetLeft;
				startY = k44.offsetTop;
				const mouseX = e.clientX + window.scrollX;
				const mouseY = e.clientY + window.scrollY;
				k44.dataset.offsetX = mouseX - startX;
				k44.dataset.offsetY = mouseY - startY;
				e.preventDefault();
			});

			document.addEventListener('mousemove', (e) =>
			{
				if (!isDragging4) return;
				const mouseX = e.clientX + window.scrollX;
				const mouseY = e.clientY + window.scrollY;
				k44.style.left = (mouseX - parseFloat(k44.dataset.offsetX)) + 'px';
				k44.style.top = (mouseY - parseFloat(k44.dataset.offsetY)) + 'px';

				const dist = Math.sqrt(
					Math.pow(k44.offsetLeft - startX, 2) +
					Math.pow(k44.offsetTop - startY, 2)
				);
				if (dist > 756)
				{  // 20cm ≈ 756px
					paper_img.src = 'img/k4.png';
					k44.remove();
					step_brushImg()
				}
			});

			document.addEventListener('mouseup', () =>
			{
				isDragging4 = false;
			});
		}

		let isBrush = false
		function step_brushImg()
		{
			if (isBrush) return;
			isBrush = true;
			brushImg.src = 'img/K5/k5-2.png';

			// 创建遮罩区域 (120%)
			const rect = brushImg.getBoundingClientRect();
			const centerX = rect.left + rect.width / 2 + window.scrollX;
			const centerY = rect.top + rect.height / 2 + window.scrollY;
			const size = rect.width * 1.1;

			const maskArea = {
				x: centerX - size / 2,
				y: centerY - size / 2,
				width: size,
				height: size
			};

			// 创建 k4-4.png
			const k44 = new Image();
			k44.src = 'img/K5/k5-1.png';
			k44.style.position = 'absolute';
			k44.style.left = (maskArea.x - 200) + 'px';
			k44.style.top = maskArea.y + 'px';
			k44.style.width = maskArea.width + 'px';
			k44.style.height = maskArea.height + 'px';
			k44.style.cursor = 'move';
			k44.style.zIndex = '1002';
			document.body.appendChild(k44);

			let isDragging4 = false;
			let startX, startY;

			k44.addEventListener('mousedown', (e) =>
			{
				isDragging4 = true;
				startX = k44.offsetLeft;
				startY = k44.offsetTop;
				const mouseX = e.clientX + window.scrollX;
				const mouseY = e.clientY + window.scrollY;
				k44.dataset.offsetX = mouseX - startX;
				k44.dataset.offsetY = mouseY - startY;
				e.preventDefault();
			});

			document.addEventListener('mousemove', (e) =>
			{
				if (!isDragging4) return;
				const mouseX = e.clientX + window.scrollX;
				const mouseY = e.clientY + window.scrollY;
				k44.style.left = (mouseX - parseFloat(k44.dataset.offsetX)) + 'px';
				k44.style.top = (mouseY - parseFloat(k44.dataset.offsetY)) + 'px';

				const dist = Math.sqrt(
					Math.pow(k44.offsetLeft - startX, 2) +
					Math.pow(k44.offsetTop - startY, 2)
				);
				if (dist > 378)
				{
					brushImg.src = 'img/K5/k5-1.png';
					k44.remove();
					step_finishImg();
				}
			});

			document.addEventListener('mouseup', () =>
			{
				isDragging4 = false;
			});
		}
		let isFinish = false
		function step_finishImg()
		{
			if (isFinish) return;
			isFinish = true;
			finishImg.src = 'img/K6/k6-1.png';
			finishImg.classList.remove('disabled-image');

			const rect = finishImg.getBoundingClientRect();
			const left = rect.left + window.scrollX;
			const top = rect.top + window.scrollY;

			const k61 = new Image();
			k61.src = 'img/K6/k6-2.png';
			k61.style.position = 'absolute';
			k61.style.left = left + 'px';
			k61.style.top = top + 'px';
			k61.style.width = rect.width + 'px';
			k61.style.height = rect.height + 'px';
			k61.style.zIndex = '10';
			k61.style.opacity = '0';
			document.body.appendChild(k61);

			const k62 = new Image();
			k62.src = 'img/K6/k6-3.png';
			k62.style.position = 'absolute';
			k62.style.left = left + 'px';
			k62.style.top = top + 'px';
			k62.style.width = rect.width + 'px';
			k62.style.height = rect.height + 'px';
			k62.style.zIndex = '10';
			k62.style.opacity = '0';
			document.body.appendChild(k62);

			let current = 0;
			const imgs = [k61, k62];
			const durations = [0.08, 0.12, 0.08, 0.15, 0.1, 0.18, 0.12, 0.2]; // 光芒闪动节奏
			let idx = 0;

			const flash = () =>
			{
				imgs[current].style.opacity = '0';
				current = 1 - current;
				imgs[current].style.transition = `opacity ${durations[idx]}s ease`;
				imgs[current].style.opacity = '1';
				idx = (idx + 1) % durations.length;
				setTimeout(flash, durations[idx] * 1000);
			};
			setTimeout(flash, 100); // 延迟启动
		}

		document.addEventListener('mousemove', (e) =>
		{
			if (!isDragging) return;
			glueImg.style.left = (e.clientX - offsetX) + 'px';
			glueImg.style.top = (e.clientY - offsetY) + 'px';

			const glueRect = glueImg.getBoundingClientRect();
			let allHighlighted = true;

			scatterImgs.forEach(img =>
			{
				if (!img.style.display || img.style.display === 'none')
				{
					allHighlighted = false;
					return;
				}
				const scatterRect = img.getBoundingClientRect();
				const overlapping = glueRect.right > scatterRect.left && glueRect.left < scatterRect.right &&
					glueRect.bottom > scatterRect.top && glueRect.top < scatterRect.bottom;

				if (overlapping && !img.dataset.highlighted)
				{
					img.style.outline = '3px solid gold';
					img.style.outlineOffset = '-3px';
					img.dataset.highlighted = 'true';
				}
				if (!img.dataset.highlighted) allHighlighted = false;
			});

			if (allHighlighted && scatterImgs.length > 0)
			{
				// 记录 glue_img 初始位置（已通过 originalLeft/originalTop 保存）
				const targetX = originalLeft;
				const targetY = originalTop;
				const targetRect = glueImg.getBoundingClientRect(); // 用于初始尺寸
				const targetW = targetRect.width;
				const targetH = targetRect.height;

				// 所有 scatter-img 飞回初始位置并消失
				scatterImgs.forEach(img =>
				{
					if (!img.style.display || img.style.display === 'none') return;
					img.style.transition = 'all 1s cubic-bezier(0.25,0.8,0.25,1)';
					img.style.left = targetX + 'px';
					img.style.top = targetY + 'px';
					img.style.width = targetW + 'px';
					img.style.height = targetH + 'px';
					img.style.transform = 'rotate(0deg)';
					img.style.opacity = '0';
				});

				// 1秒后清理
				setTimeout(() =>
				{
					scatterImgs.forEach(img =>
					{
						img.style.display = 'none';
						img.style.opacity = '';
						img.style.transition = '';
						img.style.left = '';
						img.style.top = '';
						img.style.width = '';
						img.style.height = '';
						img.style.transform = '';
					});

					// 同时恢复 glue_img
					glueImg.style.transition = 'left 0.6s ease, top 0.6s ease';
					glueImg.style.left = originalLeft + 'px';
					glueImg.style.top = originalTop + 'px';
					glueImg.src = 'img/K2/K2-3.png';


					// 恢复 glue_img 到 DOM 原位
					if (originalNextSibling)
					{
						originalParent.insertBefore(glueImg, originalNextSibling);
					} else
					{
						originalParent.appendChild(glueImg);
					}
					glueImg.style.position = '';
					glueImg.style.left = '';
					glueImg.style.top = '';
					glueImg.style.cursor = '';
					glueImg.style.zIndex = '';
					glueImg.style.transition = '';

					step_waitingImg();

				}, 1000);

				isDragging = false;
			}
		});

		document.addEventListener('mouseup', () =>
		{
			isDragging = false;
		});

		window.addEventListener('resize', initDrag);
	</script>
</body>

</html>